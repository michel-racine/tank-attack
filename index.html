<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tank War</title>
    <style>
      body {
        background-image: linear-gradient(#444, #666, #444);
        text-align: center;
      }
      canvas {
        padding-top: 4%;
      }
    </style>
  </head>
  <body>
    <div>
      <canvas id="myCanvas" />
    </div>
    <script>
      var counter = 0;
      me = new player(300, 300);
      buddy0 = new buddy(400, 100);
      buddy1 = new buddy(500, 300);

      var thetaDerivative = 0.0;

      let xM = 0;
      let yM = 0;

      // Add click event listener to the document
      document.addEventListener('click', function (event) {
        // Update x and y variables with mouse click coordinates
        xM = event.clientX;
        yM = event.clientY;

        // You can use x and y variables here or call a function passing these values
        console.log('Mouse clicked at:', xM, yM);
      });

      window.addEventListener(
        'keydown',
        function (event) {
          if (event.defaultPrevented) {
            return;
          }
          switch (event.key) {
            case 'ArrowLeft':
              thetaDerivative -= thetaDerivative > -0.2 ? 0.05 : 0;
              break;
            case 'ArrowRight':
              thetaDerivative += thetaDerivative < 0.2 ? 0.05 : 0;
              break;
            case 'ArrowUp':
              me.radius += 0.3;
              break;
            case 'ArrowDown':
              me.radius -= 0.3;
              break;
            default:
              return;
          }

          // limit radius (think of it as speed) between zero and two
          me.radius = me.radius > 6 ? 6 : me.radius < -1 ? -1 : me.radius;
          me.theta = me.theta % (2 * Math.PI);
          event.preventDefault();
        },
        true
      ); // end add event listener

      function startGame() {
        myGameArea.start();
      }

      const canvas = document.getElementById('myCanvas');
      const ctx = canvas.getContext('2d');

      function drawTarget() {
        return new Promise((resolve) => {
          ctx.save();
          ctx.translate(xM, yM);

          // Draw the target arc circle
          ctx.beginPath();
          ctx.strokeStyle = '#F00';
          ctx.arc(0, 0, 25, 0, 2 * Math.PI); // Draw the circle
          ctx.stroke();
          ctx.closePath();

          ctx.restore();
          resolve();
        });
      } // end draw target

      function drawTank(x, y, r, theta) {
        return new Promise((resolve) => {
          ctx.save();
          ctx.translate(x, y); // Translate to the center of the rectangle before rotating
          ctx.rotate(theta);

          // Draw the rectangle - body of tank
          ctx.beginPath();
          ctx.strokeStyle = '#000'; // Border color
          ctx.fillStyle = 'rgba(255, 255, 255, 1.0)';
          ctx.lineWidth = 4;
          ctx.rect(-18, -12, 36, 24); // Rectangle centered at (0,0) after translation
          ctx.fill();
          ctx.stroke(); // Stroke after fill to ensure border appears
          ctx.closePath();

          // Draw the arc (circle) - tank turret
          ctx.beginPath();
          ctx.strokeStyle = '#000';
          ctx.arc(0, 0, r, 0, 2 * Math.PI); // Draw the circle
          ctx.stroke();
          ctx.closePath();

          // Draw the line connected to the circle
          ctx.beginPath();
          ctx.moveTo(0, 0); // Start point at the center of the circle
          ctx.lineTo(23, 0); // End point of the line (adjust coordinates as needed)
          ctx.strokeStyle = '#000'; // Set color for the line
          ctx.stroke();
          ctx.closePath();

          ctx.restore();
          resolve();
        });
      } // end drawTank

      var myGameArea = {
        canvas: document.getElementById('myCanvas'),
        start: function () {
          this.canvas.width = 1000;
          this.canvas.height = 600;
          this.context = this.canvas.getContext('2d');
          document.body.insertBefore(this.canvas, document.body.childNodes[0]);
          this.frameNo = 0;
          this.interval = setInterval(updateGameArea, 100);
        },
        clear: function () {},
      };

      function player(x, y) {
        this.x = x;
        this.y = y;
        this.theta = 0;
        this.radius = 2;

        this.update = function () {
          thetaDerivative += thetaDerivative < 0 ? 0.03 : -0.03;
          this.radius += this.radius > 4 ? -0.1 : 0;
          this.theta += thetaDerivative;
          this.theta =
            this.x > 1000 || this.x < 0
              ? Math.PI - (this.theta % (2 * Math.PI))
              : this.y > 600 || this.y < 0
              ? (2 * Math.PI - this.theta) % (2 * Math.PI)
              : this.theta;
          this.x += this.radius * Math.cos(this.theta);
          this.y += this.radius * Math.sin(this.theta);
          this.x = this.x > 1000 ? 0 : this.x < 0 ? 1000 : this.x;
          this.y = this.y > 600 ? 0 : this.y < 0 ? 600 : this.y;

          drawTank(this.x, this.y, 10, this.theta); // magic 10 is radius of player
        };
      } // end function player

      function deferBuddy0() {
        if (
          Math.sqrt(
            Math.pow(buddy0.x - me.x, 2) + Math.pow(buddy0.y - me.y, 2)
          ) < 80
        )
          buddy0.radius *= 0.8;
      }
      function deferBuddy1() {
        if (
          Math.sqrt(
            Math.pow(buddy0.x - buddy1.x, 2) + Math.pow(buddy0.y - buddy1.y, 2)
          ) < 80
        )
          buddy1.radius *= 0.8;
      }

      function buddy(x, y) {
        this.x = x;
        this.y = y;
        this.theta = 0;
        this.radius = 2 + Math.random() * 2; // effectively speed

        this.update = function () {
          xM = me.x;
          yM = me.y;
          var x1 = xM - this.x;
          var y1 = yM - this.y;
          // var x1 = me.x - this.x;
          // var y1 = me.x - this.y;
          this.theta = Math.atan(y1 / x1);
          if ((this.x > xM && this.y > yM) || (xM < this.x && yM > this.y))
            this.theta += Math.PI;
          if (
            Math.sqrt(Math.pow(xM - this.x, 2) + Math.pow(yM - this.y, 2)) < 80 // distance formula
          )
            this.radius -= this.radius > 0 ? 0.2 : 0;
          else this.radius += this.radius < 5 ? 0.42 : 0;
          this.x += this.radius * Math.cos(this.theta);
          this.y += this.radius * Math.sin(this.theta);
          this.x = this.x > 1000 ? 0 : this.x < 0 ? 1000 : this.x;
          this.y = this.y > 600 ? 0 : this.y < 0 ? 600 : this.y;

          drawTank(this.x, this.y, 10, this.theta); // magic 10 is radius of player
        };
      } // end function enemy

      function updateGameArea() {
        myGameArea.clear();
        ctx.fillStyle = 'rgba(150,150,150,0.3)';
        ctx.fillRect(0, 0, 1000, 600);
        me.update();
        buddy0.update();
        buddy1.update();
        deferBuddy0();
        deferBuddy1();
        //        drawTarget();
      } // end function updateGameArea()

      startGame();
    </script>
  </body>
</html>
